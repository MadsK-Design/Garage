<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GTA Garage Overview</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>GTA Garage Overview</h1>
  <p class="sub">Portable JSON workflow: bring your file, open it, save back to it.</p>

  <div class="row">
    <!-- Save / Load -->
    <div class="panel">
      <h2>Portable Save / Load</h2>

      <div class="btnrow">
        <button type="button" id="btnOpenPortable" class="secondary">Open JSON File</button>
        <button type="button" id="btnSaveAs" class="secondary">Create New File</button>
      </div>

      <div class="btnrow" style="margin-top:12px;">
        <button type="button" id="btnLoadFromHandle" class="secondary" disabled>Reload</button>
        <button type="button" id="btnSaveToHandle" disabled>Save to opened file</button>
      </div>

      <div class="hr"></div>


      <div id="status" class="status">Tip: Best experience is Chrome/Edge desktop.</div>
      <div id="fileInfo" class="status tiny"></div>

      <div class="divider"></div>
      

      <div class="stats">
        <div class="stat">
          <div class="stat-label">Total cars</div>
          <div class="stat-value" id="statTotalCars">0</div>
        </div>

        <div class="stat">
          <div class="stat-label">Total garages</div>
          <div class="stat-value" id="statTotalGarages">0</div>
        </div>

        <div class="stat">
          <div class="stat-label">Total capacity</div>
          <div class="stat-value" id="statTotalCapacity">0</div>
        </div>
      </div>

      <div class="cat-box">
        <div class="cat-title">Cars by category</div>
        <div id="statCats" class="cat-list"></div>
  </div>

      
      
</div>

    <!-- Add Garage -->
    <div class="panel">
      <h2>Add Garage</h2>

      <label for="garageId">Garage name</label>
      <input id="garageId" placeholder="Enter Garage Name Here">

      <label for="garageAmount">Capacity</label>
      <input id="garageAmount" type="number" min="1" value="10">

      <div class="btnrow" style="margin-top: 12px;">
        <button type="button" id="btnAddGarage">Add garage</button>
      </div>

      <div class="status tiny">Names must be unique. Capacity must be 1+.</div>

      <div class="divider"></div>

        <label for="carSearch">Search for car</label>
        <input id="carSearch" placeholder="Type car name">

        <label for="searchType">Category filter</label>
        <input id="searchType" placeholder="Type category">

        <div class="status tiny">Matches will show below.</div>
        <div id="searchResults" class="search-results"></div>

    </div>

    




    <!-- Add Car -->
    <div class="panel">
      <h2>Add Car</h2>

      <label for="carName">Car name</label>
      <input id="carName" placeholder="Enter Car Name Here">

      <label for="carType">Car type / category</label>
      <select id="carType"></select>

      <label for="carGarage">Put in garage</label>
      <select id="carGarage"></select>

      <div class="btnrow" style="margin-top: 12px;">
        <button type="button" id="btnAddCar">Add Car</button>
      </div>

      <div class="divider"></div>

      <label for="randomMode">Random mode</label>
        <select id="randomMode">
            <option value="any" selected>Any category</option>
            <option value="type">Only from category</option>
        </select>

    <label for="randomType">Random category</label>
    <select id="randomType" disabled></select>


      <div class="btnrow" style="margin-top: 12px;">
        <button type="button" id="btnRandomCar" class="secondary">Pick Random Car</button>
      </div>

      <div id="randomOut" class="random-result"></div>
    </div>
  </div>

  <!-- Garages -->
  <div id="garageGrid" class="grid"></div>

  <div class="footer">
    Data format:
    <span class="chip">[{ id, amount, cars: [{ name, type }] }]</span>
  </div>

<script>
/* =============================
   GTA5 Garage App (Portable JSON)
   ============================= */

let state = { garages: [] };

// This is the important part for "portable file":
// If the user opens a file using the File System Access API,
// we keep a handle to it so "Save" overwrites that same file.
let fileHandle = null;

let isDirty = false;

const CAR_TYPES = [
  "Super","Sports","Sports Classics","Muscle","SUV","Coupe","Sedan",
  "Compact","Off-Road","Motorcycle","Vans","Utility","Commercial",
  "Industrial","Emergency","Service","Military","Boat","Plane","Helicopter","Other"
];

const $ = (id) => document.getElementById(id);
function setStatus(msg, type = "") {const el = $("status"); el.textContent = msg; el.classList.remove("error", "success", "dirty"); if (type) el.classList.add(type);}

function setFileInfo(msg, type = "") {const el = $("fileInfo"); el.textContent = msg; el.classList.remove("info", "warning"); if (type) el.classList.add(type);}
function markDirty() {isDirty = true; updateFileButtons();}// shows yellow "Unsaved changes"



function normalize(s) { return (s || "").trim(); }
function safeId(s) {return String(s).toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");}
function supportsFSA() { return ("showOpenFilePicker" in window) && ("showSaveFilePicker" in window); }

function garageById(id) { return state.garages.find(g => g.id === id); }
function sortGarages() { state.garages.sort((a,b) => a.id.localeCompare(b.id)); }

function saveCache() { localStorage.setItem("gta_garages_v2", JSON.stringify(state)); }
function loadCache() {
  const raw = localStorage.getItem("gta_garages_v2");
  if (!raw) return;
  try {
    const parsed = JSON.parse(raw);
    if (parsed && Array.isArray(parsed.garages)) state = parsed;
  } catch {}
}

function exportGaragesArray() {
  return state.garages;
}

function importGaragesArray(arr) {
  if (!Array.isArray(arr)) throw new Error("JSON must be an array of garages.");
  const clean = arr.map((g, idx) => {
    const id = normalize(g.id);
    const amount = Number(g.amount);
    const cars = Array.isArray(g.cars) ? g.cars : [];

    if (!id) throw new Error(`Garage at index ${idx} missing "id".`);
    if (!Number.isFinite(amount) || amount < 1) throw new Error(`Garage "${id}" has invalid "amount".`);

    const cleanCars = cars.map((c, cidx) => {
      const name = normalize(c.name);
      const type = normalize(c.type) || "Other";
      if (!name) throw new Error(`Garage "${id}" has car at index ${cidx} without a name.`);
      return { name, type };
    }).slice(0, amount);

    return { id, amount, cars: cleanCars };
  });

  // Unique ids
  const ids = new Set();
  for (const g of clean) {
    if (ids.has(g.id)) throw new Error(`Duplicate garage id: "${g.id}"`);
    ids.add(g.id);
  }

  state = { garages: clean };
  sortGarages();
  saveCache();
  render();
}

/* ---------- Permission helpers ---------- */

async function requestReadWritePermission(handle) {
  if (!handle) return false;

  // Some implementations support queryPermission/requestPermission
  try {
    if (handle.queryPermission) {
      const q = await handle.queryPermission({ mode: "readwrite" });
      if (q === "granted") return true;
    }
    if (handle.requestPermission) {
      const r = await handle.requestPermission({ mode: "readwrite" });
      return r === "granted";
    }
  } catch (e) {
    console.warn("Permission request failed:", e);
  }

  // If permission API isn't present, we'll try writing later and catch errors.
  return true;
}

function updateFileButtons() {
  const hasHandle = !!fileHandle;

  $("btnSaveToHandle").disabled = !hasHandle;

  // No file opened -> RED
  if (!hasHandle) {
    setStatus("No file opened — open or create a JSON file.", "error");
    setFileInfo("No file is currently opened.", "warning");
    return;
  }

  // File opened + unsaved changes -> YELLOW
  if (isDirty) {
    setStatus("Unsaved changes", "dirty");
    setFileInfo("File opened (remember to save).", "info");
    return;
  }

  // File opened + clean/saved -> GREEN
  setStatus("Saved", "success");
  setFileInfo("Portable file opened (browser keeps a secure reference).", "info");
}




/* ---------- Rendering ---------- */

function renderTypes() {
  $("carType").innerHTML = CAR_TYPES.map(t => `<option value="${t}">${t}</option>`).join("");
}

function renderStats() {
  const totalGarages = state.garages.length;
  const totalCapacity = state.garages.reduce((sum, g) => sum + (Number(g.amount) || 0), 0);

  let totalCars = 0;
  const byType = {}; // { "Super": 3, ... }

  for (const g of state.garages) {
    for (const c of (g.cars || [])) {
      totalCars += 1;
      const t = (c.type || "Other").trim() || "Other";
      byType[t] = (byType[t] || 0) + 1;
    }
  }

  // Top numbers
  const elCars = $("statTotalCars");
  const elGarages = $("statTotalGarages");
  const elCap = $("statTotalCapacity");

  if (elCars) elCars.textContent = totalCars;
  if (elGarages) elGarages.textContent = totalGarages;
  if (elCap) elCap.textContent = totalCapacity;

  // Category breakdown
  const catWrap = $("statCats");
  if (!catWrap) return;

  // Show all categories in your CAR_TYPES order, plus any unknown types at the end
  const ordered = [...CAR_TYPES];
  for (const t of Object.keys(byType)) {
    if (!ordered.includes(t)) ordered.push(t);
  }

  const rows = [];
  for (const t of ordered) {
    const n = byType[t] || 0;
    if (n === 0) continue; // hide categories with 0 to keep it clean
    rows.push({ type: t, count: n });
  }

  // If no cars
  if (!rows.length) {
    catWrap.innerHTML = `<div class="cat-empty">No cars yet</div>`;
    return;
  }

  catWrap.innerHTML = rows.map(r => `
    <div class="cat-row">
      <div class="cat-name">${escapeHtml(r.type)}</div>
      <div class="cat-count">${r.count}</div>
    </div>
  `).join("");
}

function renderGaragesSelect() {
  const sel = $("carGarage");
  sel.innerHTML = "";

  if (!state.garages.length) {
    sel.innerHTML = `<option value="">No garages yet</option>`;
    sel.disabled = true;
    return;
  }

  sel.disabled = false;
  for (const g of state.garages) {
    const free = g.amount - g.cars.length;
    const opt = document.createElement("option");
    opt.value = g.id;
    opt.textContent = `${g.id} (${g.cars.length}/${g.amount}, ${free} free)`;
    sel.appendChild(opt);
  }
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
  }[c]));
}

function renderRandomTypes() {
  const sel = $("randomType");
  sel.innerHTML = CAR_TYPES
    .map(t => `<option value="${t}">${t}</option>`)
    .join("");
}

function renderGarages() {
  const grid = $("garageGrid");
  grid.innerHTML = "";

  if (!state.garages.length) {
    const empty = document.createElement("div");
    empty.className = "panel";
    empty.innerHTML = `<h2>No garages yet</h2><div class="status">Add a garage above to get started.</div>`;
    grid.appendChild(empty);
    return;
  }

  for (const g of state.garages) {
    const card = document.createElement("div");
    card.className = "garage";

    card.id = `garage-${safeId(g.id)}`;

    const head = document.createElement("div");
    head.className = "ghead";

    const title = document.createElement("div");
    title.className = "gtitle";
    title.textContent = g.id;

    const meta = document.createElement("div");
    meta.className = "gmeta";
    meta.textContent = `${g.cars.length}/${g.amount}`;

    head.appendChild(title);
    head.appendChild(meta);

    const slots = document.createElement("div");
    slots.className = "slots";

    for (let i = 0; i < g.amount; i++) {
      const slot = document.createElement("div");
      slot.className = "slot";

      if (i < g.cars.length) {
        const car = g.cars[i];
        const left = document.createElement("div");
        left.innerHTML = `<div class="carname">${escapeHtml(car.name)}</div>
                          <div class="cartype">${escapeHtml(car.type)}</div>`;

        const right = document.createElement("button");
        right.type = "button";
        right.className = "secondary";
        right.style.width = "auto";
        right.textContent = "Remove";
        right.addEventListener("click", () => {
          g.cars.splice(i, 1);
          saveCache();
          markDirty();
          render();
        });

        slot.appendChild(left);
        slot.appendChild(right);
      } else {
        slot.classList.add("empty");
        slot.innerHTML = `<div class="carname">Empty</div><div class="cartype">Slot ${i+1}</div>`;
      }

      slots.appendChild(slot);
    }

    const actions = document.createElement("div");
    actions.className = "btnrow";
    actions.style.marginTop = "10px";

    const del = document.createElement("button");
    del.type = "button";
    del.className = "secondary";
    del.textContent = "Delete garage";
    del.addEventListener("click", () => {
      state.garages = state.garages.filter(x => x.id !== g.id);
      saveCache();
      markDirty();
      render();
    });


    actions.appendChild(del);

    card.appendChild(head);
    card.appendChild(slots);
    card.appendChild(actions);
    grid.appendChild(card);
  }
}

function render() {
  renderTypes();
  renderRandomTypes()
  renderGaragesSelect();
  renderGarages();
  renderStats();
  updateFileButtons();
  runCarSearch();
}

/* ---------- Random mode toggle ---------- */
// Ensure correct state on first load
function syncRandomModeUI() {
  $("randomType").disabled = $("randomMode").value !== "type";
}

$("randomMode").addEventListener("change", syncRandomModeUI);
syncRandomModeUI(); // initial state

/* ---------- App actions ---------- */
function runCarSearch() {
  const nameQ = normalize($("carSearch").value).toLowerCase();
  const typeQ = normalize($("searchType").value).toLowerCase();
  const out = $("searchResults");
  out.innerHTML = "";

  // If both empty, show nothing
  if (!nameQ && !typeQ) return;

  const matches = [];

  for (const g of state.garages) {
    for (const c of g.cars) {
      const nameMatch = !nameQ || c.name.toLowerCase().includes(nameQ);
      const typeMatch = !typeQ || c.type.toLowerCase().includes(typeQ);

      if (nameMatch && typeMatch) {
        matches.push({ garage: g.id, name: c.name, type: c.type });
      }
    }
  }

  if (!matches.length) {
    out.innerHTML = `<div class="status tiny">No matches.</div>`;
    return;
  }

  for (const m of matches) {
    const item = document.createElement("div");
    item.className = "search-item";
    item.innerHTML = `
      <div class="top">${escapeHtml(m.name)} <span style="opacity:.75;">(${escapeHtml(m.type)})</span></div>
      <div class="sub">Garage: ${escapeHtml(m.garage)}</div>
    `;

    // IMPORTANT: use safeId() because your garage cards are id="garage-${safeId(g.id)}"
    item.addEventListener("click", () => {
      const el = document.getElementById(`garage-${safeId(m.garage)}`);
      if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    out.appendChild(item);
  }
}

// Live search from BOTH inputs
$("carSearch").addEventListener("input", runCarSearch);
$("searchType").addEventListener("input", runCarSearch);

$("btnAddGarage").addEventListener("click", () => {
  const id = normalize($("garageId").value);
  const amount = Number($("garageAmount").value);

  if (!id) return alert("Please enter a garage name/id.");
  if (!Number.isFinite(amount) || amount < 1) return alert("Capacity must be 1 or more.");
  if (garageById(id)) return alert("That garage already exists.");

  state.garages.push({ id, amount, cars: [] });
  sortGarages();
  $("garageId").value = "";
  saveCache();
  markDirty();
  render();  
});

// Enter key in garage name → add garage
$("garageId").addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    $("btnAddGarage").click();
  }
});

// Enter key in capacity → add garage
$("garageAmount").addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    $("btnAddGarage").click();
  }
});

$("btnAddCar").addEventListener("click", () => {
  const name = normalize($("carName").value);
  const type = normalize($("carType").value) || "Other";
  const gid = normalize($("carGarage").value);

  if (!name) return alert("Enter a car name.");
  if (!gid) return alert("Choose a garage.");

  const g = garageById(gid);
  if (!g) return alert("Garage not found.");
  if (g.cars.length >= g.amount) return alert(`"${g.id}" is full.`);

  g.cars.push({ name, type });
  $("carName").value = "";
  saveCache();
  markDirty();
  render();
});

$("carName").addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    $("btnAddCar").click();
  }
});

$("carType").addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    $("btnAddCar").click();
  }
});

$("carGarage").addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    $("btnAddCar").click();
  }
});



$("btnRandomCar").addEventListener("click", () => {
  const mode = $("randomMode").value;      // "any" or "type"
  const wantedType = $("randomType").value;

  const all = [];

  for (const g of state.garages) {
    for (const c of g.cars) {
      // If filtering by category, skip others
      if (mode === "type" && c.type !== wantedType) continue;

      all.push({
        garage: g.id,
        name: c.name,
        type: c.type
      });
    }
  }

  if (!all.length) {
    $("randomOut").textContent =
      mode === "type"
        ? `No cars found in category "${wantedType}".`
        : "No cars yet.";
    return;
  }

  const pick = all[Math.floor(Math.random() * all.length)];
  $("randomOut").textContent =
    `${pick.name} (${pick.type}) - From ${pick.garage}`;
});


/* ---------- Portable file workflow ---------- */

// 1) OPEN EXISTING FILE (portable: USB/Drive/etc.)
$("btnOpenPortable").addEventListener("click", async () => {
  try {
    if (!supportsFSA()) {
      alert("Portable open+save works best in Chrome/Edge desktop. Use Download/Upload instead.");
      return;
    }

    const [handle] = await window.showOpenFilePicker({
      multiple: false,
      types: [{ description: "JSON", accept: { "application/json": [".json"] } }]
    });

    fileHandle = handle;

    // Request write permission up front (will prompt the user)
    const ok = await requestReadWritePermission(fileHandle);

    // Load regardless (even if user denied write, we can still read)
    const file = await fileHandle.getFile();
    const text = await file.text();
    importGaragesArray(JSON.parse(text || "[]"));

    // Enable/disable Save depending on permission
    $("btnSaveToHandle").disabled = !ok;
    $("btnLoadFromHandle").disabled = false;

  setStatus(
  ok ? "File opened with write access." : "File opened (read-only).",
  "success"
);

  } catch (e) {
    setStatus("Open cancelled.");
    console.error(e);
  }
});

// 2) CREATE / SAVE AS (choose a writable location)
$("btnSaveAs").addEventListener("click", async () => {
  try {
    if (!supportsFSA()) {
      alert("Save As works best in Chrome/Edge desktop. Use Download instead.");
      return;
    }

    fileHandle = await window.showSaveFilePicker({
      suggestedName: "gta-garages.json",
      types: [{ description: "JSON", accept: { "application/json": [".json"] } }]
    });

    const ok = await requestReadWritePermission(fileHandle);
    if (!ok) {
      setStatus("Write permission not granted. Cannot save to that file.", "error");
      return;
    }

    await saveToHandle();
    isDirty = false;
    updateFileButtons();       // updates file state UI
    setStatus("File created and saved ✅", "success");

  } catch (e) {
    setStatus("Save As cancelled.");
    console.error(e);
  }
});


// 3) SAVE to opened handle
async function saveToHandle() {
  if (!fileHandle) throw new Error("No file opened/created yet.");

  // Write JSON array (garages) to file
  const writable = await fileHandle.createWritable();
  await writable.write(JSON.stringify(exportGaragesArray(), null, 2));
  await writable.close();

  $("btnSaveToHandle").disabled = false;
  $("btnLoadFromHandle").disabled = false;
  updateFileButtons();
}

$("btnSaveToHandle").addEventListener("click", async () => {
  try {
    if (!fileHandle) return alert("Open a portable file or Save As first.");

    const ok = await requestReadWritePermission(fileHandle);
    if (!ok) {
      alert("No write permission. Use 'Create / Save As…' to save a writable copy.");
      return;
    }

    await saveToHandle();
    isDirty = false;

    // ✅ Explicit save feedback
    setStatus("Saved", "success");

  } catch (e) {
    alert("Save failed: " + (e?.message || e));
    console.error(e);
    setStatus("Save failed ❌ (see console)", "error");
  }
});


// 4) RELOAD from opened handle
$("btnLoadFromHandle").addEventListener("click", async () => {
  try {
    if (!fileHandle) return alert("Open a portable file first.");
    const file = await fileHandle.getFile();
    const text = await file.text();
    importGaragesArray(JSON.parse(text || "[]"));
    setStatus("Reloaded from opened file ✅");
  } catch (e) {
    alert("Reload failed: " + (e?.message || e));
    console.error(e);
  }
});



/* ---------- Init ---------- */

(function init() {
  loadCache();
  sortGarages();
  render();

  if (!supportsFSA()) {
    setStatus("Your browser doesn't support portable open+save. Use Download/Upload, or open in Chrome/Edge desktop.");
  } else {
    setStatus("Use 'Open JSON (portable)' for USB/Dropbox files, then 'Save to opened file'.");
  }
})();
</script>
</body>
</html>
